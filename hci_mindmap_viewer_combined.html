<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>HCI Mindmap Viewer (Collapse-on-Load)</title>
  <style>
    body { margin:0; overflow:hidden; font-family:sans-serif }
    .node circle { fill:#fff; stroke:steelblue; stroke-width:1.5px }
    .node text   { font-size:12px; fill:#333 }
    .link        { fill:none; stroke:#ccc; stroke-width:1.5px }
    .tooltip     { position:absolute; padding:4px 8px; background:rgba(255,255,255,0.9);
                    border:1px solid #aaa; border-radius:4px; pointer-events:none; }
  </style>
</head>
<body>
  <svg width="100%" height="100%"></svg>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const svg    = d3.select("svg"),
          width  = window.innerWidth,
          height = window.innerHeight;
    const g = svg.call(d3.zoom().on("zoom", e=>g.attr("transform",e.transform)))
                  .append("g");

    const tree = d3.tree().size([height-100, width-200]);
    const tooltip = d3.select("body").append("div")
                      .attr("class","tooltip").style("opacity",0);

    d3.json("assets/hci_mindmap_combined.json").then(data=>{
      const root = d3.hierarchy(data);
      let idCounter = 0;

      // 1) 로드 직후, depth>1인 건 모두 접어 놓기
      function collapseAll(d){
        if(d.children){
          d._children = d.children;
          d._children.forEach(collapseAll);
          d.children = null;
        }
      }
      root.children.forEach(collapseAll);

      root.x0 = height/2;
      root.y0 = 0;
      update(root);

      function update(source){
        const treeData = tree(root),
              nodes    = treeData.descendants(),
              links    = treeData.links();

        nodes.forEach(d=>d.y = d.depth * 180);

        // NODE
        const node = g.selectAll("g.node")
          .data(nodes, d=>d.id||(d.id=++idCounter));

        const nodeEnter = node.enter().append("g")
          .attr("class","node")
          .attr("transform",`translate(${source.y0},${source.x0})`)
          .on("click",(e,d)=>{
            // 클릭 시 펼치기/접기
            d.children = d.children ? null : d._children;
            update(d);
          })
          .on("mouseover",(e,d)=>{
            tooltip.style("opacity",1)
                   .html(d.data.name)
                   .style("left",(e.pageX+10)+"px")
                   .style("top",(e.pageY-20)+"px");
          })
          .on("mouseout",()=>tooltip.style("opacity",0));

        nodeEnter.append("circle").attr("r",1e-6);
        nodeEnter.append("text")
          .attr("dy",".35em")
          .attr("x",d=>d._children?-10:10)
          .attr("text-anchor",d=>d._children?"end":"start")
          .text(d=>d.data.name);

        // UPDATE
        const nodeUpdate = nodeEnter.merge(node);
        nodeUpdate.transition().duration(300)
          .attr("transform",d=>`translate(${d.y},${d.x})`);
        nodeUpdate.select("circle").transition().duration(300).attr("r",5);

        // LINK
        const link = g.selectAll("path.link")
          .data(links, d=>d.target.id);

        const linkEnter = link.enter().insert("path","g")
          .attr("class","link")
          .attr("d",d3.linkHorizontal()
                     .x(_=>source.y0)
                     .y(_=>source.x0));

        linkEnter.merge(link).transition().duration(300)
          .attr("d",d3.linkHorizontal()
                     .x(d=>d.y)
                     .y(d=>d.x));

        // 이전 좌표 저장
        nodes.forEach(d=>{d.x0=d.x; d.y0=d.y;});
      }
    }).catch(err=>{
      console.error("JSON 로딩 오류:",err);
      alert("JSON 파일을 불러오지 못했습니다.");
    });
  </script>
</body>
</html>
